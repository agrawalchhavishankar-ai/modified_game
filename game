#include <stdio.h>
#include <conio.h>
#include <windows.h>
#include <stdlib.h>
#include <time.h>

#define OBSTACLE_COUNT 2
#define MAX_LIVES 3
#define START_SPEED 120

void resetGame(int *x, int step[], int obstaclePos[], int *score, int *lives, int *speed)
{
    *x = 1;
    *score = 0;
    *lives = MAX_LIVES;
    *speed = START_SPEED;

    for (int i = 0; i < OBSTACLE_COUNT; i++)
    {
        step[i] = rand() % 5;
        obstaclePos[i] = rand() % 3;
    }
}

int main()
{
    srand(time(0));

    int x;
    int step[OBSTACLE_COUNT];
    int obstaclePos[OBSTACLE_COUNT];
    int score;
    int lives;
    int speed;

    resetGame(&x, step, obstaclePos, &score, &lives, &speed);

    while (1)
    {
        // -------- INPUT --------
        if (_kbhit())
        {
            char ch = getch();

            if (ch == 75 && x > 0) x--;   // LEFT
            if (ch == 77 && x < 2) x++;   // RIGHT

            // Restart game when R is pressed
            if (ch == 'r' || ch == 'R')
            {
                resetGame(&x, step, obstaclePos, &score, &lives, &speed);
            }
        }

        // -------- DRAW --------
        system("cls");
        printf("\n      CAR DODGE GAME\n");
        printf("   Move : LEFT & RIGHT arrow\n");
        printf("   Restart : Press R\n");
        printf("\nLives: %d   Score: %d   Speed: %d\n\n", lives, score, speed);

        printf("|--- --- ---|\n");

        for (int i = 0; i < 10; i++)
        {
            int obstacleHere = -1;

            for (int j = 0; j < OBSTACLE_COUNT; j++)
            {
                if (step[j] == i)
                {
                    obstacleHere = j;
                    break;
                }
            }

            if (obstacleHere != -1)
            {
                int lane = obstaclePos[obstacleHere];

                if (lane == 0)      printf("| %c        |\n", 1);
                else if (lane == 1) printf("|     %c    |\n", 1);
                else if (lane == 2) printf("|        %c |\n", 1);
            }
            else
            {
                printf("|           |\n");
            }
        }

        // Player
        if (x == 0)      printf("| %c        |\n", 6);
        else if (x == 1) printf("|     %c    |\n", 6);
        else if (x == 2) printf("|        %c |\n", 6);

        // -------- COLLISION --------
        for (int i = 0; i < OBSTACLE_COUNT; i++)
        {
            if (step[i] == 10 && x == obstaclePos[i])
            {
                lives--;
                step[i] = 0;
                obstaclePos[i] = rand() % 3;

                if (lives == 0)
                {
                    system("cls");
                    printf("\n\n   GAME OVER!\n");
                    printf("   Final Score: %d\n", score);
                    printf("\nPress R to Restart or ANY key to Exit...\n");

                    char ch = getch();
                    if (ch == 'r' || ch == 'R')
                    {
                        resetGame(&x, step, obstaclePos, &score, &lives, &speed);
                    }
                    else
                    {
                        return 0;
                    }
                }
            }
        }

        // -------- DIFFICULTY BY TIME --------
        static int timeCounter = 0;
        timeCounter++;

        if (timeCounter % 50 == 0 && speed > 40)
        {
            speed -= 5;   // Increase speed slowly with time
        }

        Sleep(speed);

        // -------- MOVE OBSTACLES + SCORE --------
        for (int i = 0; i < OBSTACLE_COUNT; i++)
        {
            step[i]++;

            if (step[i] > 10)
            {
                step[i] = 0;
                obstaclePos[i] = rand() % 3;

                score++;   // SCORE INCREASE
            }
        }
    }

    return 0;
}
